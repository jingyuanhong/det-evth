# Updates - 2026-01-19

## Overview
- Updated documentation to reflect iOS 16+, existing Xcode project usage, Clinical Health Records entitlement, and prebuilt CoreML model.
- Fixed multiple Swift compile warnings/errors and a runtime crash due to localized string formatting.
- Relaunched the iOS Simulator on request.

## Documentation Changes
- Updated setup steps and entitlements in `det-evth/README.md`.
- Updated minimum requirements and notes in `det-evth/PROJECT_SPECIFICATION.md`.
- Revised `det-evth/remote-guide.docx` to open the existing project and validate target membership (no new project creation; CoreML already provided).

## Code Changes
- Added `UIKit` import to resolve `UIImage` in `det-evth/DetEvth/detevth/detevth/Features/Screening/ScreeningService.swift`.
- Fixed HealthKit compile errors and Swift 6 warnings in `det-evth/DetEvth/detevth/detevth/Services/HealthKit/HealthKitService.swift`:
  - Use `durationInSeconds` instead of missing `duration`.
  - Avoid tuple type inference to `[Any]` in heart rate mapping.
  - Avoid shadowing `max` and use `Swift.max`.
  - Updated observer Task to `@MainActor` and safe `self` capture.
  - Added `.unrecognized` case to ECG classification switch.
- Suppressed CoreML Sendable warnings with `@preconcurrency import CoreML` in `det-evth/DetEvth/detevth/detevth/Services/CoreML/ECGInferenceService.swift`.
- Cleaned PDF report warnings in `det-evth/DetEvth/detevth/detevth/Services/Report/PDFReportGenerator.swift`.
- Fixed localized formatting crash by using `String(format:)` and correct format specifiers:
  - `det-evth/DetEvth/detevth/detevth/Features/Home/HomeView.swift`
  - `det-evth/DetEvth/detevth/detevth/Features/History/HistoryView.swift`
  - `det-evth/DetEvth/detevth/detevth/Features/ResultDetail/ResultDetailView.swift`
  - `det-evth/DetEvth/detevth/detevth/Resources/Localizable/en.lproj/Localizable.strings`
  - `det-evth/DetEvth/detevth/detevth/Resources/Localizable/zh-Hans.lproj/Localizable.strings`

## Simulator
- Restarted the iOS Simulator (resolved the `eligibility.plist` missing log).

---

## Session 2 Updates

### Import Feature Fixes
- **ImportView.swift**: Implemented full PDF and image import functionality
  - Added `DocumentPicker` using `UIDocumentPickerViewController` for PDF file selection
  - Added `onChange` handler for `PhotosPicker` to process selected images
  - Removed "Take Photo" option (camera) - no image noise removal algorithm available
  - Added processing overlay, error alerts, and navigation to results
  - Connected to `ECGImageExtractor`, `ECGInferenceService`, and `ScreeningRepository`

### History Delete Functionality
- **HistoryView.swift**: Connected to Core Data for real data and deletion
  - `HistoryViewModel` now fetches from `ScreeningRepository`
  - Swipe-to-delete properly removes records from Core Data
  - Added Edit button in toolbar and pull-to-refresh support

### Profile Editing
- **ProfileView.swift**: Made all profile fields editable
  - Personal info: DOB (date picker), gender (picker), height, weight
  - Emergency contacts: Add, edit (tap name), delete (swipe)
  - Doctor's email: Editable with email keyboard
  - Connected to `UserProfileRepository` and `EmergencyContactsRepository`

### ECG Extraction Algorithm - Multi-Color Support
- **ECGImageExtractor.swift**: Auto-detects waveform color
  - Supports: Red, Black, Blue, Green waveforms
  - Samples image to detect dominant color
  - Improved thresholds: `minStripHeight` 30→20, `gapTolerance` 30→50
  - Added color detection functions: `isRed()`, `isBlack()`, `isBlue()`, `isGreen()`

### ResultDetailView - Real Data Display
- **ResultDetailView.swift**: Shows actual extracted data
  - Waveform section displays real ECG signal (downsampled to 500 points)
  - Top conditions section shows actual AI predictions (≥5% probability)
  - Uses `DiseaseConditions.all` for condition name lookup

### Heart Rate Integration
- **HomeViewModel.swift**: Connected to HealthKit and ECG-based extraction
  - Fetches today's heart rate stats from HealthKit (avg, min, max)
  - Shows `--` when HealthKit unavailable or no data
  - Added `ECGHeartRateExtractor` for R-peak detection and BPM calculation
  - `ScreeningResultModel` now includes `heartRate: Int?` field

- **HistoryView.swift**: Extracts heart rate from stored ECG signals
- **ImportView.swift**: Extracts heart rate after PDF/image import

### Model Updates
- **ScreeningResultModel**: Added fields
  - `signal: [Float]?` - ECG waveform data
  - `probabilities: [Float]?` - All 150 disease probabilities
  - `heartRate: Int?` - Extracted from ECG waveform

### Localization Updates
- **en.lproj/Localizable.strings** and **zh-Hans.lproj/Localizable.strings**:
  - Import processing messages
  - Import error messages
  - Profile editing labels
  - Results waveform/conditions no-data messages

### Info.plist Configuration
- **Info.plist**: Added HealthKit usage descriptions (required for HealthKit authorization)
  - `NSHealthShareUsageDescription` - For reading ECG and heart rate data
  - `NSHealthUpdateUsageDescription` - For saving screening results
  - Note: Add these keys in Xcode Target → Info tab to avoid duplicate Info.plist conflicts

